stages:
  - deploy

deploy_production:
  stage: deploy
  image: node:4.2.2
  script:
    # - yarn remove eslint && yarn add --dev eslint@"<8.0.0"
    - yarn install
    - yarn build
    - ssh "$PRD_USER@$PRD_HOST" './killall-next-process.sh || true'
    - ssh "$PRD_USER@$PRD_HOST" 'rm -rf ~/befitter-homepage || true'
    - ssh "$PRD_USER@$PRD_HOST" 'mkdir -p ~/befitter-homepage/ || true'
    - scp -r .next "$PRD_USER@$PRD_HOST:~/befitter-homepage/"
    - scp package.json "$PRD_USER@$PRD_HOST:~/befitter-homepage/"
    - scp -r node_modules "$PRD_USER@$PRD_HOST:~/befitter-homepage/"
    - scp -r public "$PRD_USER@$PRD_HOST:~/befitter-homepage/"
    - ssh "$PRD_USER@$PRD_HOST" 'cd befitter-homepage; yarn start > /dev/null 2>&1 &'
  tags:
    - release
  only:
    - master
  when: manual


deploy_production_old:
  stage: deploy
  image: node:4.2.2
  script:
    # - yarn remove eslint && yarn add --dev eslint@"<8.0.0"
    - yarn install
    - yarn build
    - kill -9 $(ps -ef | grep -i 'next start' | grep -v grep | awk '{print $2}') || true
    - kill -9 $(ps -ef | grep -i 'yarn start' | grep -v grep | awk '{print $2}') || true
    - yarn start > /dev/null 2>&1 &
    - 'curl -X POST "https://api.cloudflare.com/client/v4/zones/a2df40bc458243b60608a5ebbb5f36f2/purge_cache" -H "Authorization: Bearer $CF_CACHE_TOKEN"  -H "Content-Type:application/json" --data "{\"purge_everything\":true}"'
  tags:
    - befit-prod-only
  only:
    - master
